{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–î–∏–∞–ª–æ–≥ —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º</title>
    <link
      rel="stylesheet"
      href="{% static '/neuro_assistant/css/styles.css' %}"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script>
      if (typeof marked === 'undefined') {
        alert("‚ùå Marked.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è! –ü—Ä–æ–≤–µ—Ä—å CDN-—Å—Å—ã–ª–∫—É.");
      }
    </script>
  </head>
  <body>
    {% include 'includes/add_to_cart_popup.html' %}
    <div class="chat-container" x-data="chat">
      <div class="chat-box">
        <div class="chat-messages">
          <template x-for="msg in messages" :key="msg.id">
            <div
              x-html="renderMarkdown(msg.text)"
              :class="msg.role == 'assistant' ? 'chat-message assistant' : 'chat-message user'"
            ></div>
          </template>
          <div
            x-show="isConsultantTyping"
            class="chat-message assistant"
          >
            –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–∏—à–µ—Ç...
          </div>
        </div>

        <div class="cart-message" id="added_to_cart_message">
          –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É
        </div>
      </div>

      <div class="input-container">
        <input
          type="text"
          class="chat-input"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          x-model="newMessageText"
          @keydown.enter="sendMessage"
        />
        <div @click="sendMessage" class="send-button">
          <img
            src="{% static '/neuro_assistant/icons/send.svg' %}"
            width="30"
            height="30"
            alt="send"
          />
        </div>
        <button class="reset-button" @click="resetChat">–û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥</button>
      </div>
    </div>
    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("chat", () => ({
          messages: [],
          newMessageText: "",
          isConsultantTyping: false,
          url: "http://127.0.0.1:5000/api/get_answer",

          init() {
            const savedMessages = localStorage.getItem("chatMessages");
            if (savedMessages) {
              this.messages = JSON.parse(savedMessages);
            }
          },

          renderMarkdown(text) {
            let html = marked.parse(text);
            let linkRegex = /<a href=\".*?(\/products\/(\d+)).*?>(.*?)<\/a>/g;
            html = html.replace(linkRegex, (match, url, productID, name) => {
              return `<a class='add-to-cart' onclick='addToCart(${productID}, \"${name}\")'>üõí</a> <a href='${url}' target='_blank'>${name}</a>`;
            });
            return html;
          },

          sendMessage() {
            if (this.newMessageText.trim() === "") return;

            if (this.newMessageText.trim() === "/reset") {
              this.resetChat();
              return;
            }

            const payload = {
              text: this.newMessageText,
              messages: this.messages.map(message => ({
                content: message.text,
                role: message.role
              }))
            };

            console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", JSON.stringify(payload, null, 2));

            this.messages.push({
              text: this.newMessageText,
              role: "user",
              id: Date.now(),
            });

            this.isConsultantTyping = true;

            fetch(this.url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
              mode: "cors",
            })
              .then((response) => response.json())
              .then((data) => {
                const reply = data.answer || "‚ùå –û—à–∏–±–∫–∞: –æ—Ç–≤–µ—Ç –ø—É—Å—Ç.";
                this.messages.push({
                  text: reply,
                  role: "assistant",
                  id: Date.now(),
                });
                this.isConsultantTyping = false;
                localStorage.setItem(
                  "chatMessages",
                  JSON.stringify(this.messages)
                );
              })
              .catch((error) => {
                this.messages.push({
                  text: "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É.",
                  role: "assistant",
                  id: Date.now(),
                });
                this.isConsultantTyping = false;
              });

            this.newMessageText = "";
          },

          resetChat() {
            this.newMessageText = "";
            this.messages = [];
            localStorage.removeItem("chatMessages");
          },
        }));
      });
    </script>
  </body>
</html>
